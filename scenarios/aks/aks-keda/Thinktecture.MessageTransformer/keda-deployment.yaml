apiVersion: apps/v1
kind: Deployment
metadata:
  name: transformer-fn
  namespace: tt
  labels:
    app: transformer-fn
spec:
  selector:
    matchLabels:
      app: transformer-fn
  template:
    metadata:
      labels:
        app: transformer-fn
    spec:
      containers:
      - name: transformer-fn
        image: adt0acr02659.azurecr.io/message-transformer:0.0.1
        env:
        - name: AzureFunctionsJobHost__functions__0
          value: TransformMessage
        envFrom:
        - secretRef:
            name: tt-func-auth
        readinessProbe:
          failureThreshold: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 240
          httpGet:
            path: /
            port: 80
            scheme: HTTP
        startupProbe:
          failureThreshold: 3
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 240
          httpGet:
            path: /
            port: 80
            scheme: HTTP
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: transformer-fn
  namespace: tt
  labels:
    deploymentName: transformer-fn
spec:
  scaleTargetRef:
    name: transformer-fn
  pollingInterval: 5
  minReplicaCount: 0
  maxReplicaCount: 50
  triggers:
  - type: azure-servicebus
    metadata:
      queueName: inbound
      connectionFromEnv: InboundQueue
    authenticationRef:
      name: trigger-auth-servicebus
---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: trigger-auth-servicebus
  name: tt
spec:
  secretTargetRef:
    - parameter: connection
      name: tt-keda-auth
      key: KedaScaler
---
